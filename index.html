<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DLsiteおすすめ共有</title>
  <style>
    /* ===================================
       基本スタイル & 全体レイアウト
    ====================================== */
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0; 
    }
    body { 
      font-family: sans-serif; 
      background: #f5f5f5; 
      color: #333; 
    }
    .container { 
      max-width: 960px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
    }
    h2 { 
      margin-top: 2.5rem; 
      border-bottom: 2px solid #ccc; 
      padding-bottom: 0.5rem; 
    }
    hr { 
      border: none; 
      border-top: 1px solid #eee; 
      margin: 2rem 0; 
    }
    .hidden { 
      display: none !important; 
    }

    /* ===================================
       操作コントロール (ボタン、入力欄)
    ====================================== */
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: .5rem; 
      margin-bottom: 1rem; 
      align-items: center; 
    }
    .controls input { 
      flex: 1; 
      min-width: 200px; 
      padding: .5rem; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
    }
    .controls button { 
      padding: .5rem 1rem; 
      border: none; 
      color: #fff; 
      border-radius: 4px; 
      cursor: pointer; 
      transition: background-color 0.2s; 
    }

    /* 各ボタンの個別スタイル */
    #addBtn, #adminAddBtn { background: #28a745; }
    #addBtn:disabled, #adminAddBtn:disabled { opacity: .6; cursor: default; }
    #adminToggle { background: #f57c00; }
    #manageTagsBtn { background: #6a1b9a; }
    #hideBadBtn { background: #6c757d; }
    #hideBadBtn.active { background: #f44336; font-weight: bold; }
    #mosaicToggleBtn { background: #8e44ad; }
    .admin-add-genre-selector button { background-color: #aaa; border: 1px solid #999; padding: 0.3rem 0.6rem; font-size: 0.8rem; }
    .admin-add-genre-selector button.active { background-color: #2980b9; border-color: #206694; }

    /* 追加ボタンのローディングアニメーション */
    .loading { position: relative; }
    .loading::after { 
      content: ''; 
      position: absolute; 
      top: 50%; 
      right: 10px; 
      width: 16px; 
      height: 16px; 
      margin-top: -8px; 
      border: 2px solid #fff; 
      border-top-color: transparent; 
      border-radius: 50%; 
      animation: spin .6s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===================================
       タブ & コンテンツエリア
    ====================================== */
    .tabs input[type="radio"] { display: none; }
    .tabs label { 
      display: inline-block; 
      padding: .5rem 1.5rem; 
      cursor: pointer; 
      background: #eee; 
      margin-right: .5rem; 
      border-radius: 4px 4px 0 0; 
      font-weight: bold; 
    }
    .tabs input:checked + label { background: #fff; }
    .tab-content { 
      display: none; 
      padding: 1rem; 
      background: #fff; 
      border: 1px solid #ddd; 
      border-top: none; 
      border-radius: 0 4px 4px 4px; 
    }
    #tab-admin_manga:checked ~ #admin_manga, #tab-admin_game:checked ~ #admin_game,
    #tab-new:checked ~ #new, #tab-ranking:checked ~ #ranking { display: block; }
    
    /* ===================================
       グリッド & カード表示
    ====================================== */
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); 
      gap: 1rem; 
    }
    .item { 
      position: relative; 
      background: #fafafa; 
      border: 1px solid #ddd; 
      border-radius: 6px; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      cursor: pointer; 
      height: 320px; 
    }
    .item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .item img { 
      width: 100%; 
      height: 180px; 
      object-fit: cover; 
      flex-shrink: 0; 
    }
    .item-body { 
      flex: 1; 
      overflow-y: auto; 
      padding: 0 .5rem; 
    }
    .title { 
      font-size: .9rem; 
      margin: .5rem 0; 
      max-height: 2.4em; 
    }
    .tags { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 4px; 
    }
    .tag { 
      background: #ddd; 
      border-radius: 4px; 
      padding: 2px 6px; 
      font-size: .75rem; 
    }

    /* カードフッター (評価ボタンなど) */
    .item-footer { 
      margin-top: auto; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: .5rem; 
      background: #fff; 
      gap: 0.5rem; 
      flex-shrink: 0; 
    }
    .rating-buttons { 
      display: flex; 
      align-items: center; 
      gap: 4px; 
    }
    .rating-btn { 
      padding: 2px 6px; 
      font-size: .8rem; 
      border: none; 
      border-radius: 4px; 
      background: #eee; 
      cursor: pointer; 
    }
    .rating-btn.good.active { background: #4caf50; color: #fff; }
    .rating-btn.bad.active { background: #f44336; color: #fff; }
    .score-display { 
      visibility: hidden; 
      font-size: 0.9rem; 
      font-weight: bold; 
      color: #333; 
      margin-left: 0.5rem; 
    }
    #rankingGrid .score-display { visibility: visible; }

    /* カード上の管理者ボタン (削除、タグ追加) */
    .item.admin .delete-btn, .item.admin .add-tag-btn { display: flex; }
    .item:not(.admin) .delete-btn, .item:not(.admin) .add-tag-btn { display: none; }
    .add-tag-btn, .delete-btn { 
      width: 24px; 
      height: 24px; 
      font-size: 16px; 
      border: none; 
      border-radius: 50%; 
      color: #fff; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .add-tag-btn { background: #2196f3; }
    .delete-btn { 
      background: #e53935; 
      position: absolute; 
      top: 6px; 
      right: 6px; 
    }

    /* 管理者おすすめグリッドの高さ固定 */
    #adminMangaGrid,
    #adminGameGrid {
        min-height: calc(320px * 2 + 1rem);
        align-content: start;
    }
    
    /* ===================================
       ページネーション
    ====================================== */
    .pagination { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: .5rem; 
      margin-top: 1rem; 
    }
    .pagination button { 
      padding: .3rem .6rem; 
      font-size: .9rem; 
      border: 1px solid #ccc; 
      background: #fff; 
      cursor: pointer; 
    }
    .pagination button:disabled { opacity: .5; cursor: default; }

    /* ===================================
       モーダル & オーバーレイ
    ====================================== */
    .overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      z-index: 1999; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    .overlay.hidden { display: none; }

    .modal { 
      width: 90%; 
      max-width: 600px; 
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
      display: flex; 
      flex-direction: column; 
      max-height: 80vh; 
    }
    .modal-header { 
      font-weight: bold; 
      padding: 1rem; 
      border-bottom: 1px solid #ddd; 
    }
    .modal-body { 
      flex: 1; 
      overflow-y: auto; 
      padding: 1rem; 
    }
    
    /* モーダル内フォーム要素 */
    .modal-body .form-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
    .modal-body .form-row label { flex-shrink: 0; }
    .modal-body .form-row input[type="text"] { flex: 1; min-width: 50px; }
    .modal-body .category-group { margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
    .modal-body .category-title { font-weight: bold; margin-bottom: 0.5rem; }
    .modal-body .tag-list-display { list-style-type: none; padding: 0; margin: 0; columns: 3; column-gap: 1rem; }
    .modal-body .tag-list-display li { padding: 2px 0; font-size: 0.9rem; }
    
    /* タグ選択パネル個別スタイル */
    .tag-panel .modal-body { padding: 0; }
    .tag-panel .tag-search-input { width: 100%; padding: .75rem; font-size: 1rem; border: none; border-bottom: 1px solid #ddd; }
    .tag-panel .category-tabs { display: flex; flex-wrap: wrap; gap: .5rem; padding: .75rem; border-bottom: 1px solid #ddd; background: #f7f7f7; }
    .tag-panel .category-tabs button { padding: .4rem .8rem; font-size: .8rem; border: 1px solid #ccc; border-radius: 1rem; background: #fff; cursor: pointer; }
    .tag-panel .category-tabs button.active { background: #333; color: #fff; border-color: #333; }
    .tag-panel .tag-list { padding: .75rem; display: grid; height: 30vh; overflow-y: auto; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .5rem; align-content: start; }
    .tag-panel .tag-list label { display: flex; align-items: center; gap: .5rem; margin-bottom: 0; font-size: .9rem; cursor: pointer; }
    .tag-panel .tag-list input { margin: 0; }

    /* モーダル内フッター */
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: .75rem;
        background: #f7f7f7;
        border-top: 1px solid #ddd;
    }
    .modal-footer button {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
    }
    .modal-footer button:hover { opacity: 0.85; }
    #modal-close-btn, #tag-panel-reset { background-color: #6c757d; color: white; }
    #tag-panel-confirm { background-color: #ff9800; color: white; }

    /* ===================================
       その他 (トースト、モザイク)
    ====================================== */
    .toast { 
      position: fixed; 
      bottom: 1rem; 
      right: 1rem; 
      background: rgba(0,0,0,.8); 
      color: #fff; 
      padding: .5rem 1rem; 
      border-radius: 4px; 
      opacity: 0; 
      transition: opacity .3s; 
      z-index: 3000; 
    }
    .toast.show { opacity: 1; }
    
    body.mosaic-on .item img {
        filter: blur(8px);
        transition: filter 0.2s ease-in-out;
    }
    body.mosaic-on .item img:hover {
        filter: blur(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <button id="hideBadBtn">Bad評価を非表示</button>
      <button id="mosaicToggleBtn">モザイク ON</button>
    </div>

    <hr>
    <h2>管理者のおすすめ</h2>
    <div class="tabs">
        <input type="radio" id="tab-admin_manga" name="admin_tab" checked>
        <label for="tab-admin_manga">漫画</label>
        <input type="radio" id="tab-admin_game" name="admin_tab">
        <label for="tab-admin_game">ゲーム</label>

        <section id="admin_manga" class="tab-content">
            <div class="grid" id="adminMangaGrid"></div>
            <div class="pagination">
                <button id="adminMangaPrev" disabled>前へ</button>
                <span id="adminMangaCurrent">1</span>/<span id="adminMangaTotal">1</span>
                <button id="adminMangaNext" disabled>次へ</button>
            </div>
        </section>
        <section id="admin_game" class="tab-content">
            <div class="grid" id="adminGameGrid"></div>
            <div class="pagination">
                <button id="adminGamePrev" disabled>前へ</button>
                <span id="adminGameCurrent">1</span>/<span id="adminGameTotal">1</span>
                <button id="adminGameNext" disabled>次へ</button>
            </div>
        </section>
    </div>
    
    <hr>
    <h2>みんなの投稿</h2>
    <div class="controls">
      <input type="url" id="dlsiteUrl" placeholder="DLsite作品URLを貼り付け" required>
      <button id="addBtn">追加</button>
    </div>
    <div class="tabs">
      <input type="radio" id="tab-new" name="tab" checked>
      <label for="tab-new">新着</label>
      <input type="radio" id="tab-ranking" name="tab">
      <label for="tab-ranking">ランキング</label>

      <section id="new" class="tab-content">
        <div class="grid" id="newGrid"></div>
        <div class="pagination">
          <button id="newPrev" disabled>前へ</button>
          <span id="newCurrent">1</span>/<span id="newTotal">1</span>
          <button id="newNext" disabled>次へ</button>
        </div>
      </section>

      <section id="ranking" class="tab-content">
        <div class="grid" id="rankingGrid"></div>
        <div class="pagination">
          <button id="rankPrev" disabled>前へ</button>
          <span id="rankCurrent">1</span>/<span id="rankTotal">1</span>
          <button id="rankNext" disabled>次へ</button>
        </div>
      </section>
    </div>
  </div>
  
  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, query, onChildAdded, onChildChanged, onChildRemoved, push, set, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const CONSTANTS = {
      PAGE_SIZES: { user: 40, admin: 10 },
      FIREBASE_CONFIG: {
        apiKey: "AIzaSyByYU-ZNJEDO0Z4LdXyI3Pn_vHhmOqa3Go",
        authDomain: "dlsite-share.firebaseapp.com",
        databaseURL: "https://dlsite-share-default-rtdb.firebaseio.com",
        projectId: "dlsite-share",
        storageBucket: "dlsite-share-default-rtdb.appspot.com",
        messagingSenderId: "764936540510",
        appId: "1:764936540510:web:846938ef579ea0b0cf3fcf",
        measurementId: "G-LXNH02PV7J"
      },
      DB_PATHS: { WORKS: "works", ADMIN_PICKS: "adminPicks" },
    };

    const state = {
      works: {}, adminPicks: {},
      sortedWorkIds: { new: [], ranking: [] },
      sortedAdminIds: { manga: [], game: [] },
      currentPage: { new: 1, ranking: 1, admin_manga: 1, admin_game: 1 },
      clientId: null,
      hideBadlyRated: false,
      mosaicActive: false,
    };

    const dom = {
      urlInput: document.getElementById("dlsiteUrl"), addBtn: document.getElementById("addBtn"),
      grids: { new: document.getElementById("newGrid"), ranking: document.getElementById("rankingGrid"), admin_manga: document.getElementById("adminMangaGrid"), admin_game: document.getElementById("adminGameGrid") },
      paginations: {
        new: { prev: document.getElementById("newPrev"), next: document.getElementById("newNext"), current: document.getElementById("newCurrent"), total: document.getElementById("newTotal") },
        ranking: { prev: document.getElementById("rankPrev"), next: document.getElementById("rankNext"), current: document.getElementById("rankCurrent"), total: document.getElementById("rankTotal") },
        admin_manga: { prev: document.getElementById("adminMangaPrev"), next: document.getElementById("adminMangaNext"), current: document.getElementById("adminMangaCurrent"), total: document.getElementById("adminMangaTotal") },
        admin_game: { prev: document.getElementById("adminGamePrev"), next: document.getElementById("adminGameNext"), current: document.getElementById("adminGameCurrent"), total: document.getElementById("adminGameTotal") },
      },
      toast: document.getElementById("toast"),
      hideBadBtn: document.getElementById("hideBadBtn"),
      mosaicToggleBtn: document.getElementById("mosaicToggleBtn"),
    };

    const util = {
      showToast: (msg, duration = 3000) => { dom.toast.textContent = msg; dom.toast.classList.add("show"); setTimeout(() => dom.toast.classList.remove("show"), duration); },
      getClientId: () => { let id = localStorage.getItem("clientId"); if (!id) { id = crypto.randomUUID(); localStorage.setItem("clientId", id); } return id; },
      calculateTotalPages: (totalItems, pageSize) => Math.max(1, Math.ceil(totalItems / pageSize)),
      classifyWork: (work) => {
          if (!work) return 'unknown';
          if (work.manualGenre) return work.manualGenre;
          if (work.workType) {
              const type = work.workType;
              if (type === 'Book' || type === 'Comic') return 'manga';
              if (type === 'VideoGame') return 'game';
          }
          const url = work.pageUrl || '';
          if (url.includes('/comic/') || url.includes('/books/')) return 'manga';
          if (url.includes('/soft/') || url.includes('/pro/')) return 'game';
          return 'unknown';
      }
    };

    function makeCard(workId, source) {
      const data = source[workId];
      if (!data) return document.createElement('div');
      const { title, coverUrl, pageUrl, tags = {}, votes = {}, score = 0 } = data;
      const userVote = source === state.works ? (votes[state.clientId] || 0) : 0;
      const card = document.createElement("article");
      card.className = "item";
      card.dataset.id = workId;
      card.innerHTML = `<img src="${coverUrl}" alt="${title}" loading="lazy"><div class="item-body"><h3 class="title">${title}</h3><div class="tags">${Object.values(tags).map(n => `<span class="tag">${n}</span>`).join("")}</div></div><div class="item-footer"><div class="rating-buttons"><button class="rating-btn good${userVote === 1 ? ' active' : ''}" data-score="1">Good</button><button class="rating-btn bad${userVote === -1 ? ' active' : ''}" data-score="-1">Bad</button><span class="score-display">${score}</span></div></div>`;
      card.addEventListener("click", (e) => { if(e.target.closest('button')) return; window.open(pageUrl, "_blank"); });
      
      if (source === state.works) {
        card.querySelectorAll(".rating-btn").forEach(btn => { btn.addEventListener("click", (e) => { e.stopPropagation(); handleVote(workId, btn); }); });
      } else {
        card.querySelector('.rating-buttons').classList.add('hidden');
      }
      return card;
    }

    function renderPage(type) {
      const isAdminSection = type.startsWith('admin_');
      const source = isAdminSection ? state.adminPicks : state.works;
      const pageSize = isAdminSection ? CONSTANTS.PAGE_SIZES.admin : CONSTANTS.PAGE_SIZES.user;
      let sortedIds = [];
      if (isAdminSection) {
          const genre = type.split('_')[1];
          sortedIds = state.sortedAdminIds[genre] || [];
      } else {
          sortedIds = state.sortedWorkIds[type] || [];
      }
      const grid = dom.grids[type];
      const pagination = dom.paginations[type];
      let currentPage = state.currentPage[type];
      if (state.hideBadlyRated && !isAdminSection) { sortedIds = sortedIds.filter(id => (state.works[id]?.votes?.[state.clientId] || 0) !== -1); }
      const totalPages = util.calculateTotalPages(sortedIds.length, pageSize);
      if (currentPage > totalPages) currentPage = state.currentPage[type] = totalPages;
      pagination.current.textContent = currentPage; pagination.total.textContent = totalPages;
      pagination.prev.disabled = currentPage <= 1; pagination.next.disabled = currentPage >= totalPages;
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageIds = sortedIds.slice(startIndex, endIndex);
      grid.innerHTML = "";
      pageIds.forEach(id => { if (source[id]) { grid.appendChild(makeCard(id, source)); } });
    }

    async function addWork(url) {
        if (!url) return util.showToast("URLを入力してください");
        if (Object.values(state.works).some(w => w.pageUrl === url)) return util.showToast("この作品は既に追加されています");
        dom.addBtn.disabled = true; dom.addBtn.classList.add('loading');
        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(8000) });
            if (!response.ok) throw new Error('作品情報の取得に失敗');
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, "text/html");
            const title = doc.querySelector('meta[property="og:title"]')?.content || "";
            const coverUrl = doc.querySelector('meta[property="og:image"]')?.content || "";
            if (!title || !coverUrl) throw new Error("タイトル・画像の取得に失敗");
            const newWorkData = { title: title.replace(/\[DLsite.*\]/, '').trim(), coverUrl, pageUrl: url, timestamp: serverTimestamp(), tags: {}, votes: {} };
            await push(ref(getDatabase(), CONSTANTS.DB_PATHS.WORKS), newWorkData);
            util.showToast(`作品を追加しました`);
            dom.urlInput.value = "";
        } catch (err) { util.showToast(`エラー: ${err.message}`);
        } finally { dom.addBtn.disabled = false; dom.addBtn.classList.remove('loading'); }
    }

    async function handleVote(workId, btn) {
        const score = Number(btn.dataset.score);
        const currentVote = state.works[workId]?.votes?.[state.clientId] || 0;
        const newVote = currentVote === score ? 0 : score;
        const ratingButtons = btn.closest('.rating-buttons');
        ratingButtons.querySelector('.active')?.classList.remove('active');
        if (newVote !== 0) { ratingButtons.querySelector(`[data-score="${newVote}"]`).classList.add('active'); }
        try {
            const voteRef = ref(getDatabase(), `${CONSTANTS.DB_PATHS.WORKS}/${workId}/votes/${state.clientId}`);
            await (newVote === 0 ? remove(voteRef) : set(voteRef, newVote));
        } catch (error) { util.showToast(`投票エラー: ${error.message}`); ratingButtons.querySelector('.active')?.classList.remove('active'); if (currentVote !== 0) { ratingButtons.querySelector(`[data-score="${currentVote}"]`).classList.add('active'); } }
    }

    function updateSortedArrays() {
      const workValues = Object.values(state.works);
      state.sortedWorkIds.ranking = workValues.sort((a, b) => (b.score || 0) - (a.score || 0)).map(w => w.id);
      state.sortedWorkIds.new = workValues.sort((a, b) => b.timestamp - a.timestamp).map(w => w.id);
      const adminPickValues = Object.values(state.adminPicks).sort((a, b) => b.timestamp - a.timestamp);
      state.sortedAdminIds.manga = adminPickValues.filter(w => util.classifyWork(w) === 'manga').map(w => w.id);
      state.sortedAdminIds.game = adminPickValues.filter(w => util.classifyWork(w) === 'game').map(w => w.id);
    }
    
    function initializeListeners() {
        const db = getDatabase();
        const worksQuery = query(ref(db, CONSTANTS.DB_PATHS.WORKS));
        const refreshUserSection = () => { updateSortedArrays(); renderPage('new'); renderPage('ranking'); };
        const userWorkChange = (snap) => { state.works[snap.key] = { id: snap.key, ...snap.val(), score: Object.values(snap.val()?.votes || {}).reduce((s,v)=>s+v,0) }; refreshUserSection(); };
        onChildAdded(worksQuery, userWorkChange);
        onChildChanged(worksQuery, userWorkChange);
        onChildRemoved(worksQuery, (snap) => { delete state.works[snap.key]; refreshUserSection(); });

        const adminPicksQuery = query(ref(db, CONSTANTS.DB_PATHS.ADMIN_PICKS));
        const refreshAdminSection = () => { updateSortedArrays(); renderPage('admin_manga'); renderPage('admin_game'); };
        const adminWorkChange = (snap) => { state.adminPicks[snap.key] = { id: snap.key, ...snap.val() }; refreshAdminSection(); };
        onChildAdded(adminPicksQuery, adminWorkChange);
        onChildChanged(adminPicksQuery, adminWorkChange);
        onChildRemoved(adminPicksQuery, (snap) => { delete state.adminPicks[snap.key]; refreshAdminSection(); });
    }

    function setupEventListeners() {
      dom.addBtn.addEventListener("click", () => addWork(dom.urlInput.value.trim()));
      
      Object.keys(dom.paginations).forEach(type => {
        const pagination = dom.paginations[type];
        pagination.prev.addEventListener('click', () => { if (state.currentPage[type] > 1) { state.currentPage[type]--; renderPage(type); } });
        pagination.next.addEventListener('click', () => {
          const isAdmin = type.startsWith('admin_'); let ids;
          if(isAdmin) { ids = state.sortedAdminIds[type.split('_')[1]]; }
          else { ids = state.sortedWorkIds[type]; }
          if (state.hideBadlyRated && !isAdmin) { ids = ids.filter(id => (state.works[id]?.votes?.[state.clientId] || 0) !== -1); }
          const pageSize = isAdmin ? CONSTANTS.PAGE_SIZES.admin : CONSTANTS.PAGE_SIZES.user;
          const totalPages = util.calculateTotalPages(ids.length, pageSize);
          if (state.currentPage[type] < totalPages) { state.currentPage[type]++; renderPage(type); }
        });
      });

      dom.hideBadBtn.addEventListener("click", () => {
        state.hideBadlyRated = !state.hideBadlyRated;
        dom.hideBadBtn.classList.toggle('active', state.hideBadlyRated);
        dom.hideBadBtn.textContent = state.hideBadlyRated ? 'Bad評価を再表示' : 'Bad評価を非表示';
        renderPage('new'); renderPage('ranking');
      });

      dom.mosaicToggleBtn.addEventListener("click", () => {
        state.mosaicActive = !state.mosaicActive;
        localStorage.setItem('mosaicActive', state.mosaicActive);
        document.body.classList.toggle('mosaic-on', state.mosaicActive);
        dom.mosaicToggleBtn.textContent = state.mosaicActive ? 'モザイク OFF' : 'モザイク ON';
      });
    }

    function main() {
      initializeApp(CONSTANTS.FIREBASE_CONFIG);
      const savedMosaic = localStorage.getItem('mosaicActive');
      if (savedMosaic === 'true') {
        state.mosaicActive = true;
        document.body.classList.add('mosaic-on');
        dom.mosaicToggleBtn.textContent = 'モザイク OFF';
      }
      state.clientId = util.getClientId();
      initializeListeners();
      setupEventListeners();
    }
    main();
  </script>
</body>
</html>